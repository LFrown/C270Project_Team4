name: Deploy to Minikube (Remote VM)

on:
  workflow_run:
    workflows: ['Build and Test Inventory App']
    types: [completed]
  workflow_dispatch:  # Allows manual trigger if needed

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Expect (for SSH automation)
        run: |
          sudo apt-get update && sudo apt-get install -y expect

      - name: Deploy to Minikube on Remote VM
        run: |
          echo " Starting Deployment..."
          expect -c "
            spawn ssh -o StrictHostKeyChecking=no ${{ secrets.VM_USERNAME }}@${{ secrets.VM_HOST }}
            expect \"password:\"
            send \"${{ secrets.VM_PASSWORD }}\r\"
            expect \"$ \"

            send \"echo ' Connected to VM'\r\"

            # Ensure Minikube is Running
            send \"echo ' Checking Minikube status...'\r\"
            send \"minikube status || minikube start --driver=docker\r\"

            # Ensure Kubernetes is Running
            send \"kubectl cluster-info || minikube start --driver=docker\r\"

            # Run Kubernetes Deployment Commands INSIDE THE VM
            send \"echo ' Deleting old Kubernetes resources...'\r\"
            send \"kubectl delete -f /Team4_k8s_App/deployment.yaml\r\"
            send \"kubectl delete -f /Team4_k8s_App/ingress.yaml\r\"
            send \"kubectl delete -f /Team4_k8s_App/service.yaml\r\"

            send \"echo ' Applying new Kubernetes configurations...'\r\"
            send \"kubectl apply -f /Team4_k8s_App/service.yaml\r\"
            send \"kubectl apply -f /Team4_k8s_App/deployment.yaml\r\"
            send \"kubectl apply -f /Team4_k8s_App/ingress.yaml\r\"

            send \"echo ' Restarting Pods to Use Latest Image...'\r\"
            send \"kubectl rollout restart deployment inventory-manager-deployment\r\"

            send \"echo ' Restarting Minikube service...'\r\"
            send \"minikube service inventory-manager-service --url\r\"

            send \"exit\r\"
            interact
          "
