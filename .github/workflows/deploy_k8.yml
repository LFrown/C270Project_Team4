name: Deploy to Minikube (Remote VM)

on:
  workflow_run:
    workflows: ['Build and Test Inventory App']
    types: [completed]
  workflow_dispatch:  # Allows manual trigger if needed

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Expect (for SSH automation)
        run: |
          sudo apt-get update && sudo apt-get install -y expect

      - name: Run Deployment Script on Remote VM
        run: |
          echo "Starting Deployment..."
          expect -c "
            spawn ssh -o StrictHostKeyChecking=no ${{ secrets.VM_USERNAME }}@${{ secrets.VM_HOST }}
            expect \"password:\"
            send \"${{ secrets.VM_PASSWORD }}\r\"
            expect \"$ \"

            send \"echo 'Connected to VM'\r\"

            # Run Deployment Script on VM
            send \"bash /home/cedrick/C270Project_Team4/k8deployscript.sh\r\"

            send \"exit\r\"
            interact
          "
      - name: Debug SSH Connection
        run: |
          echo "üîç Testing SSH Connection to VM..."
          expect -c "
            spawn ssh -o StrictHostKeyChecking=no ${{ secrets.VM_USERNAME }}@${{ secrets.VM_HOST }}
            expect \"password:\"
            send \"${{ secrets.VM_PASSWORD }}\r\"
            expect \"$ \"
      
            send \"echo '‚úÖ SSH Connected Successfully!'\r\"
            send \"hostname\r\"
            send \"whoami\r\"
            send \"ls -lah /home/${{ secrets.VM_USERNAME }}/\r\"
            
            send \"exit\r\"
            interact
          "
